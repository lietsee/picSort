# 機能要件詳細

このドキュメントでは、画像仕分けアプリの各機能について詳細な仕様を定義する。

## 1. アプリケーション状態遷移

```mermaid
stateDiagram-v2
    [*] --> 初期状態
    初期状態 --> フォルダ未選択: 起動完了

    フォルダ未選択 --> スキャン中: 分別元フォルダ選択
    スキャン中 --> 画像表示中: 画像あり
    スキャン中 --> 画像なし: 画像なし

    画像表示中 --> 画像表示中: 前後移動
    画像表示中 --> 移動処理中: 仕分けキー押下
    移動処理中 --> 画像表示中: 移動成功（次画像あり）
    移動処理中 --> 画像なし: 移動成功（最後の画像）
    移動処理中 --> エラー表示: 移動失敗

    エラー表示 --> 画像表示中: エラー確認

    画像なし --> スキャン中: 分別元フォルダ変更
    画像表示中 --> スキャン中: 分別元フォルダ変更
    フォルダ未選択 --> フォルダ未選択: 分別先フォルダ設定
```

## 2. 分別元フォルダ選択

### 2.1 概要
仕分け対象の画像が格納されたフォルダを指定する機能。

### 2.2 選択方法

| 方法 | 操作 | 詳細 |
|------|------|------|
| ダイアログ | ボタンクリック | OSネイティブのフォルダ選択ダイアログを表示 |
| ドラッグ&ドロップ | フォルダをウィンドウにD&D | アプリウィンドウ全体がドロップターゲット |

### 2.3 処理フロー

```mermaid
flowchart TD
    A[フォルダ選択開始] --> B{選択方法}
    B -->|ダイアログ| C[フォルダ選択ダイアログ表示]
    B -->|D&D| D[ドロップイベント受信]

    C --> E{キャンセル?}
    E -->|Yes| F[処理中止]
    E -->|No| G[パス取得]

    D --> H{フォルダ?}
    H -->|No| I[エラー: フォルダを選択してください]
    H -->|Yes| G

    G --> J[パス検証]
    J --> K{アクセス可能?}
    K -->|No| L[エラー: アクセス権限がありません]
    K -->|Yes| M[画像ファイルスキャン]

    M --> N{画像あり?}
    N -->|No| O[「画像なし」表示]
    N -->|Yes| P[画像リスト生成]

    P --> Q[先頭画像を表示]
    Q --> R[次画像を先読み]
```

### 2.4 画像スキャン仕様

| 項目 | 仕様 |
|------|------|
| 対象拡張子 | .jpg, .jpeg, .png, .gif, .bmp, .webp（大文字小文字不問） |
| サブフォルダ | スキャン対象外（直下のみ） |
| 並び順 | ファイル名昇順（自然順ソート） |
| 隠しファイル | 除外（.で始まるファイル） |
| シンボリックリンク | 警告ログを出力してスキップ |
| ネットワークドライブ | 対応（初回選択時に速度警告を表示） |

### 2.5 エッジケース

| ケース | 動作 |
|--------|------|
| 空フォルダ | 「画像なし」表示 |
| 対応外ファイルのみ | 「画像なし」表示、ログに記録 |
| アクセス権限なし | エラーメッセージ表示 |
| パスが存在しない | エラーメッセージ表示 |
| スキャン中にフォルダ削除 | エラーメッセージ表示、フォルダ未選択状態へ |

## 3. 分別先フォルダ設定

### 3.1 概要
数字キー（1〜5）に対応する移動先フォルダを設定する機能。

### 3.2 設定方法

```mermaid
flowchart TD
    A[分別先ボタン n をクリック] --> B[フォルダ選択ダイアログ表示]
    B --> C{キャンセル?}
    C -->|Yes| D[設定維持]
    C -->|No| E[パス検証]

    E --> F{書き込み権限?}
    F -->|No| G[エラー: 書き込み権限がありません]
    F -->|Yes| H[設定保存]

    H --> I[ボタンラベル更新]
    I --> J[設定ファイルに永続化]
```

### 3.3 設定状態

| 状態 | ボタン表示 | キー押下時の動作 |
|------|-----------|-----------------|
| 未設定 | `1: 未設定` | 警告「分別先フォルダを設定してください」 |
| 設定済み | `1: フォルダ名` | 画像を移動 |

### 3.4 設定の永続化

設定は以下のタイミングで保存:
- フォルダ設定変更時
- アプリ終了時

設定ファイル形式:
```json
{
  "destinations": {
    "1": "/path/to/folder1",
    "2": "/path/to/folder2",
    "3": null,
    "4": null,
    "5": null
  }
}
```

### 3.5 設定解除

- 同じフォルダを再選択: 設定解除確認ダイアログ
- 右クリック/長押し: コンテキストメニューから「解除」

## 4. 画像表示

### 4.1 表示仕様

| 項目 | 仕様 |
|------|------|
| 表示形式 | スライドショー（1枚ずつ） |
| フィット方式 | アスペクト比維持、プレビュー領域にフィット |
| 背景色 | ダークテーマ: #1e1e1e / ライトテーマ: #f0f0f0 |
| アニメーション | フェード（150ms） |

### 4.2 画像読み込みフロー

```mermaid
sequenceDiagram
    participant UI as UI
    participant Loader as ImageLoader
    participant Cache as ImageCache
    participant FS as FileSystem

    UI->>Loader: loadImage(currentIndex)
    Loader->>Cache: get(currentPath)

    alt キャッシュヒット
        Cache-->>Loader: cachedImage
        Loader-->>UI: displayImage
    else キャッシュミス
        Loader->>FS: readFile(currentPath)
        FS-->>Loader: imageData
        Loader->>Loader: decode(imageData)
        Loader->>Cache: set(currentPath, image)
        Loader-->>UI: displayImage
    end

    UI->>Loader: prefetch(nextIndex)
    Loader->>FS: readFile(nextPath)
    FS-->>Loader: imageData
    Loader->>Loader: decode(imageData)
    Loader->>Cache: set(nextPath, image)
```

### 4.3 先読み戦略

| 項目 | 仕様 |
|------|------|
| 先読み枚数 | 1枚（次の画像のみ） |
| タイミング | 現在画像の表示完了後 |
| キャッシュ保持 | 現在画像 + 先読み画像 |
| キャッシュ解放 | 表示完了した前の画像 |

### 4.4 エラーハンドリング

| エラー | 動作 |
|--------|------|
| デコード失敗 | スキップしてログに記録、次の画像へ |
| ファイル読み込み失敗 | スキップしてログに記録、次の画像へ |
| メモリ不足 | キャッシュクリア、再試行 |

## 5. キーボード操作

### 5.1 キーバインド一覧

| キー | 動作 | 条件 |
|------|------|------|
| `1` | 分別先1へ移動 | 分別先1が設定済み |
| `2` | 分別先2へ移動 | 分別先2が設定済み |
| `3` | 分別先3へ移動 | 分別先3が設定済み |
| `4` | 分別先4へ移動 | 分別先4が設定済み |
| `5` | 分別先5へ移動 | 分別先5が設定済み |
| `←` / `A` | 前の画像 | 画像表示中 |
| `→` / `D` | 次の画像 | 画像表示中 |
| `Space` | 次の画像 | 画像表示中 |
| `Backspace` | 前の画像 | 画像表示中 |
| `Escape` | フルスクリーン解除 | フルスクリーン中 |
| `F` | フルスクリーン切替 | 常時 |

### 5.2 キー入力処理

```mermaid
flowchart TD
    A[キー入力] --> B{入力フィールドにフォーカス?}
    B -->|Yes| C[通常入力として処理]
    B -->|No| D{キーコード判定}

    D -->|1-5| E{分別先設定済み?}
    E -->|No| F[警告表示]
    E -->|Yes| G[移動処理実行]

    D -->|矢印キー| H{画像表示中?}
    H -->|No| I[無視]
    H -->|Yes| J[画像切替]

    D -->|その他| K[無視]

    G --> L{移動成功?}
    L -->|Yes| M[次の画像へ]
    L -->|No| N[エラー表示]
```

### 5.3 キーリピート制御

| 項目 | 仕様 |
|------|------|
| 仕分けキー（1-5） | リピート無効（押下1回で1回のみ処理） |
| 移動キー（矢印等） | リピート有効 |
| リピート間隔 | OS設定に従う |

## 6. ファイル移動

### 6.1 移動処理フロー

```mermaid
flowchart TD
    A[移動開始] --> B[ソースパス確認]
    B --> C{ソース存在?}
    C -->|No| D[エラー: ファイルが見つかりません]
    C -->|Yes| E[移動先パス生成]

    E --> F{同名ファイル存在?}
    F -->|Yes| G[連番付与]
    G --> F
    F -->|No| H[ファイル移動実行]

    H --> I{移動成功?}
    I -->|No| J[エラー処理]
    I -->|Yes| K[画像リストから削除]

    K --> L[ログ記録]
    L --> M{次の画像あり?}
    M -->|Yes| N[次の画像を表示]
    M -->|No| O[「画像なし」表示]
```

### 6.2 同名ファイル処理

重複時の連番付与ルール:

| 元ファイル名 | 重複時 |
|-------------|--------|
| `photo.jpg` | `photo_1.jpg`, `photo_2.jpg`, ... |
| `image_1.png` | `image_1_1.png`, `image_1_2.png`, ... |

連番検索上限: 999（超過時はエラー）

### 6.3 アトミック操作

| 項目 | 仕様 |
|------|------|
| 方式 | Rustの `std::fs::rename` 使用 |
| 同一ファイルシステム | 即座に完了 |
| 異なるファイルシステム | コピー後に削除 |
| 失敗時 | 元ファイル保持、ロールバック不要 |

### 6.4 エラー時の動作

| エラー種別 | 動作 | ユーザー通知 |
|-----------|------|-------------|
| 権限不足 | 処理中止 | 「書き込み権限がありません」 |
| ディスクフル | 処理中止 | 「ディスク容量が不足しています」 |
| ファイル使用中 | 処理中止 | 「ファイルが使用中です」 |
| ネットワークエラー | 処理中止 | 「ネットワークエラーが発生しました」 |

## 7. 画像リスト管理

### 7.1 リスト構造

```typescript
interface ImageList {
  sourcePath: string;        // 分別元フォルダパス
  images: ImageInfo[];       // 画像情報配列
  currentIndex: number;      // 現在表示中のインデックス
}

interface ImageInfo {
  path: string;              // 絶対パス
  name: string;              // ファイル名
  size: number;              // ファイルサイズ（バイト）
  modifiedAt: Date;          // 更新日時
}
```

### 7.2 リスト操作

| 操作 | トリガー | 処理 |
|------|----------|------|
| 生成 | フォルダ選択 | スキャンして画像リスト作成 |
| 削除 | 移動成功 | リストから該当画像を削除 |
| 再生成 | フォルダ変更 | 既存リストをクリアして再スキャン |
| インデックス更新 | 画像切替 | currentIndex を変更 |

### 7.3 インデックス境界処理

| 状況 | 動作 |
|------|------|
| 先頭で「前へ」 | 何もしない（循環しない） |
| 末尾で「次へ」 | 何もしない（循環しない） |
| 移動後インデックス超過 | 新しい末尾に調整 |

## 8. 対応拡張子フィルタ

### 8.1 判定フロー

```mermaid
flowchart TD
    A[ファイル検出] --> B[拡張子抽出]
    B --> C[小文字に正規化]
    C --> D{対応拡張子リストに含まれる?}
    D -->|Yes| E[画像リストに追加]
    D -->|No| F[スキップ]
    F --> G[ログに記録]
```

### 8.2 対応拡張子詳細

| 拡張子 | MIMEタイプ | 備考 |
|--------|-----------|------|
| `.jpg`, `.jpeg` | image/jpeg | 最も一般的 |
| `.png` | image/png | 透過サポート |
| `.gif` | image/gif | 静止画として表示 |
| `.bmp` | image/bmp | 非圧縮 |
| `.webp` | image/webp | 静止画として表示 |

### 8.3 将来の拡張候補

| 拡張子 | 優先度 | 備考 |
|--------|--------|------|
| `.heic`, `.heif` | 中 | iOS写真形式 |
| `.avif` | 低 | 次世代フォーマット |
| `.svg` | 低 | ベクター画像 |
| `.raw`, `.dng` | 低 | RAW画像 |

## 9. 外部変更検知

### 9.1 概要
分別元フォルダの内容が外部アプリケーションから変更された場合、自動的にリストを更新する。

### 9.2 監視仕様

| 項目 | 仕様 |
|------|------|
| 監視方式 | OSネイティブ（FSEvents/inotify） |
| 検知対象 | ファイル作成、削除、リネーム |
| 更新タイミング | 変更検知後500msのデバウンス |
| 監視対象 | 分別元フォルダ直下のみ（サブフォルダは対象外） |

### 9.3 状態遷移

```mermaid
flowchart TD
    A[外部変更検知] --> B{変更種別}
    B -->|ファイル追加| C[リスト末尾に追加]
    C --> D[再ソート]
    B -->|ファイル削除| E{現在表示中?}
    E -->|Yes| F[次の画像に自動遷移]
    E -->|No| G[リストから削除]
    F --> G
    G --> H[インデックス調整]
    B -->|ファイルリネーム| I[リスト更新]
    I --> D
```

### 9.4 ネットワークドライブの場合

| 状況 | 対応 |
|------|------|
| ファイルシステム監視が利用可能 | 通常どおり監視 |
| ファイルシステム監視が利用不可 | ポーリング（30秒間隔）にフォールバック |
| ポーリング中の変更検知 | 差分比較で追加/削除を検出 |

## 10. 初回起動ウィザード

### 10.1 表示条件

- アプリ初回起動時
- 設定ファイルが存在しない場合
- `wizardCompleted` フラグが `false` の場合

### 10.2 ウィザード内容（1ステップ）

キー操作の簡潔な説明を表示するモーダル：

| 要素 | 内容 |
|------|------|
| タイトル | 「ようこそ picSort へ」 |
| 説明1 | 「1〜5キーで画像を各フォルダに仕分けます」 |
| 説明2 | 「←→キーで画像を切り替えます」 |
| 説明3 | 「まず分別先フォルダを設定しましょう」 |
| ボタン | 「始める」 |
| チェックボックス | 「次回から表示しない」 |

### 10.3 ウィザード終了後

```mermaid
flowchart TD
    A[「始める」ボタンクリック] --> B{「次回から表示しない」?}
    B -->|チェックあり| C[wizardCompleted = true]
    B -->|チェックなし| D[wizardCompleted = false]
    C --> E[設定ファイル保存]
    D --> E
    E --> F[通常画面へ遷移]
```

### 10.4 設定ファイル構造（追加項目）

```json
{
  "destinations": { ... },
  "theme": "system",
  "language": "ja",
  "animation": true,
  "keyRepeat": true,
  "wizardCompleted": false,
  "window": { ... }
}
```
